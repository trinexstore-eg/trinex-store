<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TRINEX | Future of Streetwear</title>
    
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#00e676">
    <link rel="apple-touch-icon" href="favicon.png">
    <link rel="icon" type="image/png" href="favicon.png">
    
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;600;700&family=Montserrat:wght@400;700;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://unpkg.com/aos@2.3.1/dist/aos.css" rel="stylesheet">
    
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>

    <style>
        :root { --bg: #000; --text: #fff; --green: #00e676; --panel: #0a0a0a; --border: #333; --error: #ff3333; }
        body { font-family: 'Montserrat', sans-serif; background-color: var(--bg); color: var(--text); margin: 0; padding: 0; overflow-x: hidden; }
        * { box-sizing: border-box; outline: none; }
        
        /* === 1. Navbar (Top & Fixed) === */
        nav { 
            background: #000; /* ÿÆŸÑŸÅŸäÿ© ÿ≥ŸàÿØÿßÿ° ÿµÿ±Ÿäÿ≠ÿ© ÿπÿ¥ÿßŸÜ ÿ™ÿ∫ÿ∑Ÿä */
            border-bottom: 1px solid #222; 
            padding: 0 30px; /* ŸÇŸÑŸÑÿ™ ÿßŸÑÿ®ÿßÿØŸäŸÜÿ¨ ÿπÿ¥ÿßŸÜ ÿßŸÑÿßÿ±ÿ™ŸÅÿßÿπ Ÿäÿ™ÿ∏ÿ®ÿ∑ */
            height: 70px; /* ÿßÿ±ÿ™ŸÅÿßÿπ ÿ´ÿßÿ®ÿ™ ŸÑŸÑŸÜÿßŸÅÿ®ÿßÿ± */
            display: flex; justify-content: space-between; align-items: center; 
            position: fixed; top: 0; left: 0; width: 100%; 
            z-index: 1002; /* ÿ£ÿπŸÑŸâ ÿ∑ÿ®ŸÇÿ© */
        }
        
        .brand-text { font-family: 'Montserrat'; font-size: 1.8rem; font-weight: 900; color: #fff; text-decoration: none; cursor: pointer; letter-spacing: 2px; }
        .nav-links { display: flex; gap: 25px; } 
        .nav-links a { color: #ccc; text-decoration: none; font-weight: 600; transition: 0.3s; cursor: pointer; font-size: 0.9rem; text-transform: uppercase; padding-bottom: 5px; border-bottom: 2px solid transparent; } 
        .nav-links a:hover, .nav-links a.active { color: #fff; border-bottom: 2px solid var(--green); }
        .nav-icons { display: flex; gap: 20px; align-items: center; } 
        .cart-icon-wrap { position: relative; cursor: pointer; }
        .cart-count { position: absolute; top: -8px; right: -8px; background: var(--green); color: #000; font-size: 0.7rem; padding: 2px 6px; border-radius: 50%; font-weight: bold; }
        
        .user-area { display: flex; align-items: center; gap: 10px; } 
        .login-btn { background: var(--green); color: #000; padding: 6px 20px; border-radius: 20px; font-weight: bold; font-size: 0.85rem; cursor: pointer; text-decoration: none; transition: 0.3s; }
        .user-menu-btn { display: none; align-items: center; gap: 8px; color: #fff; cursor: pointer; border: 1px solid #333; padding: 5px 15px; border-radius: 20px; transition: 0.3s; }

        /* === 2. Announcement Bar (Under Navbar & Thicker) === */
        .ann-bar { 
            background: var(--green); color: #000; text-align: center; 
            padding: 15px 40px; /* ÿßÿ™ÿÆŸÜ ÿ¥ŸàŸäÿ© */
            font-weight: 800; font-size: 0.95rem; 
            position: fixed; 
            top: 70px; /* ÿ®Ÿäÿ®ÿØÿ£ ÿ®ÿπÿØ ÿßŸÑŸÜÿßŸÅÿ®ÿßÿ± ÿ®ŸÄ 70 ÿ®ŸÉÿ≥ŸÑ ÿ®ÿßŸÑÿ∏ÿ®ÿ∑ */
            width: 100%; 
            z-index: 1001; text-transform: uppercase; 
            display: flex; align-items: center; justify-content: center;
            box-shadow: 0 5px 15px rgba(0,230,118,0.2);
        }
        .ann-close { position: absolute; right: 20px; cursor: pointer; font-size: 1.4rem; font-weight: 900; transition: 0.3s; }
        .ann-close:hover { color: #fff; transform: scale(1.2); }

        /* === 3. Header (Full Screen) === */
        header { 
            height: 100vh; 
            background: url('hode1.jpg') no-repeat center center/cover; 
            display: flex; align-items: center; justify-content: center; 
            position: relative; 
            padding-top: 120px; /* ŸÖÿ≥ÿßŸÅÿ© ÿπÿ¥ÿßŸÜ ÿßŸÑŸÉŸÑÿßŸÖ ŸÖŸäÿ™ÿ∫ÿ∑ÿßÿ¥ ÿ®ÿßŸÑÿ®ÿßÿ±ÿßÿ™ */
        }
        .overlay { position: absolute; inset: 0; background: linear-gradient(to bottom, rgba(0,0,0,0.5), #000); }
        .hero-content { position: relative; z-index: 2; text-align: center; padding: 20px; animation: fadeInUp 1s ease; }
        .hero-title { font-size: 4rem; margin: 0; font-family: 'Montserrat'; letter-spacing: 5px; text-transform: uppercase; text-shadow: 0 0 30px rgba(0,230,118,0.3); }
        .hero-sub { font-size: 1.2rem; color: #ccc; margin: 15px 0 30px; letter-spacing: 3px; font-weight: 300; }
        .hero-btn { padding: 15px 50px; background: var(--green); color: #000; border: none; font-weight: 900; font-size: 1.1rem; cursor: pointer; border-radius: 50px; transition: 0.3s; text-transform: uppercase; font-family: 'Montserrat'; letter-spacing: 1px; }
        .hero-btn:hover { transform: scale(1.05); box-shadow: 0 0 25px var(--green); color: #fff; background: #000; border: 2px solid var(--green); }

        .container { display: flex; flex-wrap: wrap; justify-content: center; gap: 30px; max-width: 1300px; margin: 0 auto; min-height: 50vh; padding-bottom: 50px; }
        .card { background: var(--panel); border: 1px solid var(--border); width: 300px; border-radius: 0; overflow: hidden; transition: 0.3s; position: relative; }
        .card:hover { transform: translateY(-5px); border-color: #555; }
        .img-area { display: block; width: 100%; height: 380px; overflow: hidden; background: #111; cursor: pointer; position: relative; }
        .img-area img { width: 100%; height: 100%; object-fit: cover; transition: 0.6s; }
        .card:hover img { transform: scale(1.1); opacity: 0.8; }
        .quick-view-btn { position: absolute; bottom: -50px; left: 0; width: 100%; background: rgba(0,0,0,0.8); color: #fff; border: none; padding: 15px; font-weight: bold; cursor: pointer; transition: 0.3s; text-transform: uppercase; letter-spacing: 1px; z-index: 10; }
        .card:hover .quick-view-btn { bottom: 0; }
        .quick-view-btn:hover { background: var(--green); color: #000; }
        .card-actions { display: flex; justify-content: space-between; padding: 15px; position: absolute; top: 0; width: 100%; z-index: 5; }
        .action-btn { background: rgba(0,0,0,0.5); border: none; color: #fff; cursor: pointer; font-size: 1.1rem; width: 35px; height: 35px; border-radius: 50%; display: flex; align-items: center; justify-content: center; transition: 0.3s; backdrop-filter: blur(5px); }
        .action-btn:hover { background: #fff; color: #000; transform: scale(1.1); }
        .action-btn.liked { color: #ff0050; background: rgba(255,255,255,0.1); }
        .action-btn.saved { color: #FFD700; background: rgba(255,255,255,0.1); }
        .info { padding: 20px; text-align: left; }
        .info h3 { font-family: 'Montserrat'; font-size: 1rem; margin: 0; color: #fff; text-transform: uppercase; letter-spacing: 1px; overflow: hidden; white-space: nowrap; text-overflow: ellipsis; }
        .price { display: block; margin-top: 5px; color: #888; font-weight: 600; font-family: 'Montserrat'; }
        .stock-counter { font-size: 0.75rem; color: var(--error); font-weight: bold; margin-top: 10px; display: block; }
        .stock-bar { width: 100%; height: 3px; background: #333; margin-top: 5px; position: relative; }
        .stock-fill { position: absolute; left: 0; top: 0; height: 100%; background: var(--error); width: 20%; }
        .buy-btn { display: block; width: 100%; padding: 12px 0; margin-top: 15px; background: #fff; border: none; color: #000; font-weight: 900; cursor: pointer; font-family: 'Montserrat'; transition: 0.3s; text-transform: uppercase; letter-spacing: 1px; }
        .buy-btn:hover { background: var(--green); }

        .side-cart { position: fixed; top: 0; right: -400px; width: 380px; height: 100vh; background: #111; z-index: 2000; border-left: 1px solid #333; transition: 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275); display: flex; flex-direction: column; }
        .side-cart.open { right: 0; }
        .cart-header { padding: 20px; border-bottom: 1px solid #333; display: flex; justify-content: space-between; align-items: center; }
        .cart-items { flex: 1; padding: 20px; overflow-y: auto; }
        .cart-item { display: flex; gap: 15px; margin-bottom: 20px; border-bottom: 1px solid #222; padding-bottom: 15px; }
        .cart-item img { width: 70px; height: 80px; object-fit: cover; border-radius: 5px; }
        .cart-footer { padding: 20px; border-top: 1px solid #333; background: #0a0a0a; }
        .checkout-btn { width: 100%; padding: 15px; background: var(--green); color: #000; border: none; font-weight: 900; cursor: pointer; text-transform: uppercase; }
        
        .modal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.9); z-index: 3000; align-items: center; justify-content: center; backdrop-filter: blur(5px); }
        .modal-content { 
            background: #111; padding: 0; width: 900px; max-width: 95%; 
            border: 1px solid #333; display: flex; position: relative; 
            animation: zoomIn 0.3s ease;
            max-height: 90vh; overflow-y: auto; 
        }
        @media (max-width: 768px) { .modal-content { flex-direction: column; } }
        
        .modal-left { flex: 1; background: #000; display: flex; align-items: center; justify-content: center; }
        .modal-left img { width: 100%; height: 100%; object-fit: cover; }
        .modal-right { flex: 1; padding: 40px; text-align: left; }
        .modal-close { position: absolute; top: 15px; right: 20px; color: #fff; font-size: 2rem; cursor: pointer; z-index: 10; }
        
        .form-group { margin-bottom: 15px; }
        .form-group input, .form-group textarea, .form-group select { width: 100%; background: #0a0a0a; border: 1px solid #333; padding: 12px; color: #fff; font-family: 'Montserrat'; transition: 0.3s; }
        .form-group input:focus { border-color: var(--green); }
        .form-group .error-msg { color: var(--error); font-size: 0.75rem; margin-top: 5px; display: none; }
        
        footer { background: var(--panel); padding: 60px 20px; text-align: center; border-top: 1px solid var(--border); margin-top: auto; }
        .social-icons { display: flex; justify-content: center; gap: 20px; margin-bottom: 30px; }
        
        .social-icons a { 
            font-size: 1.5rem; width: 50px; height: 50px; 
            border-radius: 50%; border: 1px solid #333; 
            display: flex; align-items: center; justify-content: center; 
            text-decoration: none; transition: 0.3s; color: #888;
        }

        .social-icons a.facebook:hover { background: #1877F2; color: #fff; border-color: #1877F2; transform: translateY(-5px); box-shadow: 0 0 15px #1877F2; }
        .social-icons a.instagram:hover { background: radial-gradient(circle at 30% 107%, #fdf497 0%, #fdf497 5%, #fd5949 45%, #d6249f 60%, #285AEB 90%); color: #fff; border-color: transparent; transform: translateY(-5px); box-shadow: 0 0 15px #d6249f; }
        .social-icons a.tiktok:hover { background: #000; color: #fff; border-color: #fff; text-shadow: 2px 2px 0px #ff0050, -2px -2px 0px #00f2ea; transform: translateY(-5px); box-shadow: 0 0 15px rgba(255,255,255,0.5); }

        .whatsapp-float { position: fixed; bottom: 30px; right: 30px; background: #25d366; color: #FFF; border-radius: 50%; width: 50px; height: 50px; display: flex; align-items: center; justify-content: center; font-size: 28px; z-index: 1000; text-decoration: none; box-shadow: 0 5px 20px rgba(0,0,0,0.5); transition: 0.3s; }
        .whatsapp-float:hover { transform: scale(1.1); background: #1ebd56; }
        
        .wa-tooltip { 
            position: fixed; bottom: 38px; right: 90px;
            background: #222; color: #fff; border: 1px solid var(--green);
            padding: 8px 12px; border-radius: 20px 0 0 20px; 
            font-weight: bold; font-size: 0.8rem; box-shadow: 0 5px 15px rgba(0,0,0,0.3); 
            animation: floatMsg 3s infinite; pointer-events: none; z-index: 1000;
        }
        .wa-tooltip::after { 
            content: ''; position: absolute; bottom: 10px; right: -6px; 
            border-width: 6px 0 6px 6px; border-style: solid; 
            border-color: transparent transparent transparent #222; 
        }

        @keyframes floatMsg { 0%, 100% { transform: translateY(0); opacity: 1; } 50% { transform: translateY(-5px); opacity: 1; } }
        @keyframes zoomIn { from { opacity: 0; transform: scale(0.9); } to { opacity: 1; transform: scale(1); } }
        @keyframes fadeInUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        @media (max-width: 768px) { nav { padding: 0 15px; } .nav-links { display: none; } .hero-title { font-size: 2.5rem; } .card { width: 100%; max-width: 350px; } .side-cart { width: 100%; right: -100%; } }
    </style>
</head>
<body id="body">

    <nav id="navbar">
        <a onclick="location.reload()" class="brand-text">TRINEX</a>
        <div class="nav-links">
            <a onclick="setActive(this); fetchProducts('all')" class="active" id="link-all">All</a>
            <a onclick="setActive(this); fetchProducts('winter')" id="link-winter">Winter</a>
            <a onclick="setActive(this); fetchProducts('summer')" id="link-summer">Summer</a>
            <a onclick="setActive(this); fetchProducts('pants')" id="link-pants">Pants</a>
            <a onclick="openPolicy()">Brand Policy</a>
        </div>
        <div class="nav-icons">
            <div class="cart-icon-wrap" onclick="openSideCart()">
                <i class="fas fa-shopping-bag" style="color:#fff; font-size:1.2rem;"></i>
                <span class="cart-count" id="cartCount">0</span>
            </div>
            <div class="user-area">
                <a href="login.html" id="loginBtn" class="login-btn">LOGIN</a>
                <div id="userProfile" class="user-menu-btn" onclick="location.href='profile.html'">
                    <span id="userNameTxt" style="font-size:0.85rem;"></span><i class="fas fa-user-circle"></i>
                </div>
            </div>
        </div>
    </nav>

    <div class="ann-bar" id="announcementBar">
        TRINEX | FUTURE OF STREETWEAR üöÄ
        <span class="ann-close" onclick="document.getElementById('announcementBar').style.display='none'">&times;</span>
    </div>

    <div class="side-cart" id="sideCart">
        <div class="cart-header"><h2 style="margin:0; font-family:'Montserrat'; color:#fff;">YOUR CART</h2><span class="close-cart" onclick="closeSideCart()" style="cursor:pointer; font-size:1.5rem;">&times;</span></div>
        <div class="cart-items" id="cartItemsContainer"></div>
        <div class="cart-footer">
            <div style="display:flex; justify-content:space-between; margin-bottom:20px; font-weight:bold; font-size:1.2rem;"><span>Total:</span><span id="cartTotal">0 EGP</span></div>
            <button class="checkout-btn" onclick="proceedToCheckout()">SECURE CHECKOUT <i class="fas fa-lock"></i></button>
        </div>
    </div>

    <header>
        <div class="overlay"></div>
        <div class="hero-content">
            <h1 class="hero-title">FUTURE OF STREETWEAR</h1>
            <p class="hero-sub">EST. 2025 // CAIRO</p>
            <button class="hero-btn" onclick="document.getElementById('productsSection').scrollIntoView({behavior: 'smooth'})">SHOP COLLECTION üëá</button>
        </div>
    </header>

    <div id="productsSection">
        <h2 class="section-title">LATEST <span>DROP</span></h2>
        <div id="loader" style="text-align: center; color: var(--green); margin-top: 50px;">Connecting to Server...</div>
        <div class="container" id="productsContainer"></div>
    </div>

    <footer>
        <div class="social-icons">
            <a href="https://www.instagram.com/trinex.store.eg" class="instagram" target="_blank"><i class="fab fa-instagram"></i></a>
            <a href="https://www.tiktok.com/@trinex.store.eg" class="tiktok" target="_blank"><i class="fab fa-tiktok"></i></a>
            <a href="#" class="facebook" target="_blank"><i class="fab fa-facebook-f"></i></a>
        </div>
        <p style="color:#666; margin-top:15px; font-size:0.8rem;">&copy; 2025 TRINEX. All Rights Reserved.</p>
        <div style="margin-top:20px; color:#666; font-size:0.9rem; cursor:pointer;" onclick="openPolicy()"><u>Shipping Policy</u> | <u>Returns & Exchange</u></div>
    </footer>

    <a href="https://wa.me/201035898768" class="whatsapp-float" target="_blank"><i class="fab fa-whatsapp"></i></a>
    <div class="wa-tooltip">ÿ™ŸàÿßÿµŸÑ ŸÖÿπŸÜÿß üí¨</div>

    <div id="quickViewModal" class="modal"><div class="modal-content"><span class="modal-close" onclick="closeModal('quickViewModal')">&times;</span><div class="modal-left"><img id="qv-img" src=""></div><div class="modal-right"><h2 id="qv-title" style="color:#fff; font-family:'Montserrat'; text-transform:uppercase;"></h2><h3 id="qv-price" style="color:var(--green); margin-bottom:20px;"></h3><p style="color:#ccc; line-height:1.6;">Premium streetwear fabric. Limited Drop.</p>
        <div style="margin-top:20px;"><label style="color:#fff; font-weight:bold; display:block; margin-bottom:10px;">SIZE:</label><select id="qv-size" style="width:100%; padding:10px; background:#222; border:1px solid #444; color:#fff;"></select></div>
        <div style="margin-top:15px;"><label style="color:#fff; font-weight:bold; display:block; margin-bottom:10px;">COLOR:</label><select id="qv-color" style="width:100%; padding:10px; background:#222; border:1px solid #444; color:#fff;"></select></div>
        <p class="stock-counter" style="margin-top:20px;">üî• Only <span id="qv-stock"></span> items left!</p><button class="buy-btn" id="qv-add-btn" style="background:var(--green); margin-top:20px;">ADD TO CART</button></div></div></div>

    <div id="checkoutModal" class="modal">
        <div class="modal-content" style="width:500px;">
            <span class="modal-close" onclick="closeModal('checkoutModal')">&times;</span>
            <div style="padding:40px; width:100%;">
                <h2 style="color:var(--green); border-bottom:1px solid #333; padding-bottom:15px;">SECURE CHECKOUT</h2>
                <div class="form-group"><label>Full Name *</label><input type="text" id="co_name"><span class="error-msg" id="err_name">Required</span></div>
                <div class="form-group"><label>Primary Phone *</label><input type="number" id="co_phone1"><span class="error-msg" id="err_phone1">Required</span></div>
                <div class="form-group"><label>Backup Phone *</label><input type="number" id="co_phone2"><span class="error-msg" id="err_phone2">Required</span></div>
                <div class="form-group"><label>Address *</label><textarea id="co_address" rows="3"></textarea><span class="error-msg" id="err_address">Required</span></div>
                
                <div class="form-group">
                    <label>Payment Method</label>
                    <select id="co_payment">
                        <option value="Cash on Delivery">Cash on Delivery (ÿßŸÑÿØŸÅÿπ ÿπŸÜÿØ ÿßŸÑÿßÿ≥ÿ™ŸÑÿßŸÖ)</option>
                        <option value="Instapay">Instapay (ÿ™ÿ≠ŸàŸäŸÑ ÿßŸÜÿ≥ÿ™ÿß ÿ®ÿßŸä)</option>
                        <option value="Vodafone Cash">Vodafone Cash (ŸÅŸàÿØÿßŸÅŸàŸÜ ŸÉÿßÿ¥)</option>
                    </select>
                </div>

                <div style="margin:20px 0; border:1px dashed #333; padding:10px;">
                    <label style="color:#aaa; font-size:0.8rem;">Have a Promo Code?</label>
                    <div style="display:flex; gap:10px;">
                        <input type="text" id="promoCodeInput" placeholder="Enter Code" style="flex:1; padding:8px; text-transform:uppercase;">
                        <button onclick="applyCoupon()" style="background:#333; color:#fff; border:none; padding:0 15px; cursor:pointer;">APPLY</button>
                    </div>
                    <p id="promoMsg" style="font-size:0.8rem; margin-top:5px;"></p>
                </div>

                <div style="display:flex; justify-content:space-between; margin-bottom:20px;">
                    <span style="color:#aaa;">Total:</span>
                    <span id="finalTotalDisplay" style="color:#fff; font-weight:bold; font-size:1.2rem;">0 EGP</span>
                </div>

                <button class="buy-btn" onclick="submitOrder()">CONFIRM ORDER</button>
            </div>
        </div>
    </div>

    <div id="policyModal" class="modal"><div class="modal-content" style="width:600px; display:block; padding:30px;"><span class="modal-close" onclick="closeModal('policyModal')">&times;</span><h2 style="color:var(--green);">BRAND POLICY üìú</h2><ul style="list-style:none; padding:0; color:#ccc; line-height:1.8;"><li><i class="fas fa-check-circle" style="color:var(--green);"></i> <b>Inspection:</b> Open & check before paying.</li><li><i class="fas fa-check-circle" style="color:var(--green);"></i> <b>Exchange:</b> 14 days for defects (Free).</li><li><i class="fas fa-check-circle" style="color:var(--green);"></i> <b>Returns:</b> Must be in original condition.</li><li><i class="fas fa-shipping-fast" style="color:var(--green);"></i> <b>Shipping:</b> 2-4 days Cairo/Giza.</li></ul></div></div>

    <script src="https://unpkg.com/aos@2.3.1/dist/aos.js"></script>
    <script> AOS.init(); </script>
    
    <script>
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('sw.js')
            .then(() => console.log("App Installed"))
            .catch(err => console.log("PWA Error", err));
        }
    </script>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
        import { getFirestore, collection, getDocs, orderBy, query, doc, getDoc, updateDoc, increment, setDoc, addDoc, serverTimestamp, arrayUnion, where } 
        from "https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js";
        import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-auth.js";

        const firebaseConfig = { apiKey: "AIzaSyDpC3kyBhy-mWsYjVAHxUuy2pqg_Sh0Z8U", authDomain: "trinex-store.firebaseapp.com", projectId: "trinex-store", storageBucket: "trinex-store.firebasestorage.app", messagingSenderId: "265387866506", appId: "1:265387866506:web:1fb7786e186cf0abf43073" };
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);

        // --- TELEGRAM CONFIG ---
        const TG_TOKEN = "8233185585:AAFDkBVq4UEs1SXqBU27qN5VYEIyiPzX39Q";
        const TG_CHAT_ID = "8395954291";

        let allProducts = [];
        let currentUser = null;
        let userData = null;
        let discountApplied = 0;

        window.setActive = function(elem) { document.querySelectorAll('.nav-links a').forEach(a => a.classList.remove('active')); elem.classList.add('active'); }

        window.initApp = async function() {
            try {
                const settingsSnap = await getDoc(doc(db, "settings", "general"));
                if (settingsSnap.exists()) {
                    let data = settingsSnap.data();
                    if (data.announcement) document.getElementById('announcementBar').childNodes[0].nodeValue = data.announcement + " ";
                    if (data.heroImg) document.querySelector('header').style.backgroundImage = `url('${data.heroImg}')`;
                }
            } catch(e) {}
            const today = new Date().toISOString().split('T')[0];
            try { await setDoc(doc(db, "stats", today), { visits: increment(1) }, { merge: true }); } catch(e) {}
            const container = document.getElementById('productsContainer');
            try {
                const q = query(collection(db, "products"), orderBy("createdAt", "desc"));
                const querySnapshot = await getDocs(q);
                document.getElementById('loader').style.display = 'none';
                if(querySnapshot.empty) { container.innerHTML = "<p style='color:#666;'>No products found.</p>"; return; }
                allProducts = [];
                querySnapshot.forEach((doc) => { allProducts.push({ id: doc.id, ...doc.data() }); });
                window.renderCards('all');
            } catch(e) { document.getElementById('loader').innerText = "Connection Error!"; }
        }

        onAuthStateChanged(auth, async (user) => {
            if (user) {
                currentUser = user;
                localStorage.setItem('trinex_user_logged', 'true');
                document.getElementById('loginBtn').style.display = 'none';
                document.getElementById('userProfile').style.display = 'flex';
                document.getElementById('userNameTxt').innerText = user.displayName || "MEMBER";
                const userDoc = await getDoc(doc(db, "users", user.uid));
                if(userDoc.exists()) { userData = userDoc.data(); }
                await setDoc(doc(db, "users", user.uid), { lastSeen: serverTimestamp() }, { merge: true });
            } else {
                currentUser = null; userData = null;
                localStorage.removeItem('trinex_user_logged');
            }
        });

        window.renderCards = function(category) {
            const container = document.getElementById('productsContainer');
            container.innerHTML = "";
            let filtered = (category === 'all') ? allProducts : allProducts.filter(p => p.category === category);
            if(filtered.length === 0) { container.innerHTML = "<p style='color:#666; width:100%; text-align:center;'>Empty Section.</p>"; return; }
            filtered.forEach(p => {
                let safeData = JSON.stringify(p).replace(/"/g, '&quot;');
                let stock = p.stock || 5; 
                let html = `<div class="card" data-id="${p.id}" data-aos="fade-up">
                    <div class="img-area" onclick="openQuickView(${safeData}, ${stock})"><img src="${p.img}" onerror="this.src='favicon.png'"><button class="quick-view-btn" onclick="openQuickView(${safeData}, ${stock}); event.stopPropagation();"><i class="far fa-eye"></i> Quick View</button></div>
                    <div class="card-actions"><button class="action-btn" onclick="toggleAction(this, 'like', '${p.id}', '${p.name}', '${p.img}')"><i class="far fa-heart"></i></button><button class="action-btn" onclick="toggleAction(this, 'save', '${p.id}', '${p.name}', '${p.img}')"><i class="far fa-bookmark"></i></button></div>
                    <div class="info"><h3>${p.name}</h3><span class="price">${p.price} EGP</span><div class="stock-bar"><div class="stock-fill" style="width:${(stock/20)*100}%"></div></div><span class="stock-counter">Only ${stock} left!</span><button class="buy-btn" onclick="openQuickView(${safeData}, ${stock})">ADD TO CART</button></div>
                </div>`;
                container.innerHTML += html;
            });
            restoreActions();
        }
        window.fetchProducts = window.renderCards;

        window.toggleAction = async function(btn, type, id, name, img) {
            if(!currentUser) { alert("Please Login First!"); location.href="login.html"; return; }
            let key = type === 'like' ? 'trinex_likes' : 'trinex_saved';
            let list = JSON.parse(localStorage.getItem(key)) || [];
            if(list.includes(id)) { 
                list = list.filter(i => i !== id); 
                btn.classList.remove(type === 'like' ? 'liked' : 'saved'); btn.querySelector('i').classList.replace('fas', 'far');
            } else { 
                list.push(id); 
                btn.classList.add(type === 'like' ? 'liked' : 'saved'); btn.querySelector('i').classList.replace('far', 'fas'); 
                if(type === 'save') {
                    await updateDoc(doc(db, "products", id), { savedCount: increment(1) });
                    // Store rich data for profile
                    await updateDoc(doc(db, "users", currentUser.uid), { 
                        wishlistItems: arrayUnion({id: id, name: name, img: img}) 
                    }).catch(async ()=>{
                       await setDoc(doc(db,"users",currentUser.uid), { wishlistItems: [{id: id, name: name, img: img}] }, { merge:true });
                    });
                }
            }
            localStorage.setItem(key, JSON.stringify(list));
        }

        window.applyCoupon = async () => {
            let code = document.getElementById('promoCodeInput').value.toUpperCase();
            let msg = document.getElementById('promoMsg');
            const q = query(collection(db, "coupons"), where("code", "==", code));
            const snap = await getDocs(q);
            if(!snap.empty) {
                let discount = snap.docs[0].data().discount;
                discountApplied = discount;
                msg.innerText = `Coupon Applied: ${discount}% OFF!`; msg.style.color = "var(--green)";
                updateFinalTotal();
            } else {
                discountApplied = 0;
                msg.innerText = "Invalid Code"; msg.style.color = "red";
                updateFinalTotal();
            }
        }

        function updateFinalTotal() {
            let cartSum = parseFloat(document.getElementById('cartTotal').innerText);
            let final = cartSum - (cartSum * (discountApplied/100));
            document.getElementById('finalTotalDisplay').innerText = Math.ceil(final) + " EGP";
        }

        // --- NEW ORDER LOGIC (Telegram + Confetti + Alert Only) ---
        window.submitOrder = async function() {
            let name = document.getElementById('co_name').value;
            let phone1 = document.getElementById('co_phone1').value;
            let phone2 = document.getElementById('co_phone2').value;
            let address = document.getElementById('co_address').value;
            let payment = document.getElementById('co_payment').value;
            
            if(name.length < 3 || phone1.length < 11 || address.length < 5) { alert("Please check your details!"); return; }
            if(!currentUser) { alert("Please Login!"); location.href="login.html"; return; }
            
            let btn = document.querySelector('#checkoutModal .buy-btn');
            let oldText = btn.innerText;
            btn.innerText = "Processing... ‚è≥";
            btn.disabled = true;

            let dbItems = cart.map(i => ({name: i.name, price: i.price, img: i.img, size: i.size, color: i.color}));
            let finalPrice = document.getElementById('finalTotalDisplay').innerText;

            let orderData = {
                customerName: name, phone: phone1, phone2: phone2, address: address, paymentMethod: payment,
                items: dbItems, total: finalPrice, discount: discountApplied, date: new Date().toLocaleString(),
                status: 'New', userId: currentUser.uid
            };

            try {
                // 1. Firebase Save
                await addDoc(collection(db, "orders"), orderData);
                await setDoc(doc(db, "users", currentUser.uid), { ordersCount: increment(1) }, { merge: true });

                // 2. Telegram Send
                let itemsList = cart.map(i => `- ${i.name} [${i.size}/${i.color}]`).join('\n');
                let tgMsg = `üö® *NEW ORDER!* üö®\n\nüë§ *Customer:* ${name}\nüì± *Phone:* ${phone1} / ${phone2}\nüìç *Address:* ${address}\nüí∞ *Total:* ${finalPrice}\nüí≥ *Method:* ${payment}\n\nüì¶ *Items:*\n${itemsList}`;
                
                await fetch(`https://api.telegram.org/bot${TG_TOKEN}/sendMessage`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ chat_id: TG_CHAT_ID, text: tgMsg, parse_mode: 'Markdown' })
                });

                // 3. Success (Confetti + Alert Only)
                closeModal('checkoutModal');
                
                // Fire Confetti
                confetti({ particleCount: 150, spread: 70, origin: { y: 0.6 } });
                
                // Simple Success Alert
                alert(`‚úÖ ÿ¥ŸÉÿ±ÿßŸã ŸÑÿ´ŸÇÿ™ŸÉ Ÿäÿß ${name}!\nÿ™ŸÖ ÿßÿ≥ÿ™ŸÑÿßŸÖ ÿ∑ŸÑÿ®ŸÉ ÿ®ŸÜÿ¨ÿßÿ≠ÿå ÿ≥ŸÜÿ™ŸàÿßÿµŸÑ ŸÖÿπŸÉ ŸÇÿ±Ÿäÿ®ÿßŸã.`);
                
                // Clear Cart
                cart = []; localStorage.setItem('trinex_cart', JSON.stringify(cart)); updateCartCount();

            } catch(e) { 
                console.error(e); 
                alert("Something went wrong. Please check internet connection.");
            } finally {
                btn.innerText = oldText;
                btn.disabled = false;
            }
        }

        window.proceedToCheckout = () => { 
            if(cart.length===0) return; 
            closeSideCart(); 
            openModal('checkoutModal');
            document.getElementById('finalTotalDisplay').innerText = document.getElementById('cartTotal').innerText;
            if(userData) {
                document.getElementById('co_name').value = userData.name || "";
                document.getElementById('co_phone1').value = userData.phone || "";
                document.getElementById('co_address').value = userData.address || "";
            }
        }

        let cart = JSON.parse(localStorage.getItem('trinex_cart')) || [];
        window.addToCart = (p) => { 
            if(!currentUser) { alert("Login First!"); location.href="login.html"; return; }
            let s = document.getElementById('qv-size').value;
            let c = document.getElementById('qv-color').value;
            if(!s && document.getElementById('quickViewModal').style.display !== 'flex') s = "M"; 
            if(!c && document.getElementById('quickViewModal').style.display !== 'flex') c = "Black";
            let item = {...p, size: s, color: c};
            cart.push(item); 
            localStorage.setItem('trinex_cart', JSON.stringify(cart)); updateCartCount(); openSideCart(); 
            if(document.getElementById('quickViewModal').style.display === 'flex') closeModal('quickViewModal');
        }

        window.openSideCart = () => { document.getElementById('sideCart').classList.add('open'); const cont = document.getElementById('cartItemsContainer'); cont.innerHTML = ""; let total = 0; cart.forEach((item, i) => { total += parseFloat(item.price); cont.innerHTML += `<div class="cart-item"><img src="${item.img}"><div style="flex:1;"><h4 style="color:#fff;margin:0;">${item.name}</h4><span style="color:#888; font-size:0.8rem;">${item.size} / ${item.color}</span><br><span style="color:var(--green);">${item.price} EGP</span></div><span onclick="removeFromCart(${i})" style="color:red;cursor:pointer;">&times;</span></div>`; }); document.getElementById('cartTotal').innerText = total + " EGP"; }
        window.removeFromCart = (i) => { cart.splice(i,1); localStorage.setItem('trinex_cart', JSON.stringify(cart)); openSideCart(); updateCartCount(); }
        window.closeSideCart = () => document.getElementById('sideCart').classList.remove('open');
        window.updateCartCount = () => document.getElementById('cartCount').innerText = cart.length;
        
        window.openQuickView = (p, s) => { 
            document.getElementById('qv-img').src = p.img; document.getElementById('qv-title').innerText = p.name; 
            document.getElementById('qv-price').innerText = p.price + " EGP"; document.getElementById('qv-stock').innerText = s;
            let sSelect = document.getElementById('qv-size'); sSelect.innerHTML = "";
            let sizes = p.sizes || ["S", "M", "L", "XL", "XXL"]; 
            sizes.forEach(sz => sSelect.innerHTML += `<option>${sz}</option>`);
            let cSelect = document.getElementById('qv-color'); cSelect.innerHTML = "";
            let colors = p.colors || ["Black", "White"]; 
            colors.forEach(cl => cSelect.innerHTML += `<option>${cl}</option>`);
            document.getElementById('qv-add-btn').onclick = () => { addToCart(p); }; 
            openModal('quickViewModal'); 
        }
        
        window.openModal = (id) => document.getElementById(id).style.display = 'flex';
        window.closeModal = (id) => document.getElementById(id).style.display = 'none';
        window.openPolicy = () => openModal('policyModal');
        window.logout = () => signOut(auth).then(() => location.reload());
        function restoreActions() {
            let likes = JSON.parse(localStorage.getItem('trinex_likes')) || [];
            let saved = JSON.parse(localStorage.getItem('trinex_saved')) || [];
            document.querySelectorAll('.card').forEach(card => {
                let id = card.dataset.id;
                if(likes.includes(id)) { let btn = card.querySelectorAll('.action-btn')[0]; btn.classList.add('liked'); btn.querySelector('i').classList.replace('far', 'fas'); }
                if(saved.includes(id)) { let btn = card.querySelectorAll('.action-btn')[1]; btn.classList.add('saved'); btn.querySelector('i').classList.replace('far', 'fas'); }
            });
        }
        updateCartCount(); initApp();
        
        window.onclick = (e) => { if (e.target.classList.contains('modal')) e.target.style.display = "none"; }
    </script>
</body>
</html>