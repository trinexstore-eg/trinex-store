<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TRINEX | Super Admin</title>
    <link rel="icon" type="image/png" href="favicon.png">
    
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@300;600;700&family=Montserrat:wght@400;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        /* === Core Variables === */
        :root { --bg: #0d0d0d; --panel: #1a1a1a; --text: #fff; --border: #333; --green: #00e676; --sidebar: #000; --sidebar-text: #888; --hover: #222; --error: #ff3333; --info: #29b6f6; }
        * { box-sizing: border-box; outline: none; transition: 0.3s; }
        body { font-family: 'Cairo', sans-serif; background-color: var(--bg); color: var(--text); margin: 0; padding: 0; height: 100vh; display: flex; overflow: hidden; }

        /* === Login Screen === */
        #loginScreen { position: fixed; inset: 0; background: #000; z-index: 9999; display: flex; flex-direction: column; align-items: center; justify-content: center; background-image: url('hode1.jpg'); background-size: cover; }
        .overlay { position: absolute; inset: 0; background: rgba(0,0,0,0.9); }
        .login-box { position: relative; z-index: 2; background: var(--panel); padding: 40px; border-radius: 15px; border: 1px solid var(--border); width: 400px; text-align: center; box-shadow: 0 0 50px rgba(0,230,118,0.2); }
        .inp-field { width: 100%; padding: 15px; margin-bottom: 15px; background: #000; border: 1px solid #333; color: #fff; border-radius: 8px; font-family: 'Montserrat'; text-align: center; font-weight: bold; }
        .inp-field:focus { border-color: var(--green); }
        .main-btn { width: 100%; padding: 15px; background: var(--green); color: #000; font-weight: 900; border: none; border-radius: 8px; cursor: pointer; text-transform: uppercase; font-family: 'Montserrat'; }
        .main-btn:hover { background: #fff; transform: translateY(-3px); }

        /* === Layout === */
        .sidebar { width: 260px; background: var(--sidebar); display: flex; flex-direction: column; padding: 20px; border-left: 1px solid var(--border); }
        .brand { font-family: 'Montserrat'; font-size: 1.8rem; color: #fff; text-align: center; margin-bottom: 30px; letter-spacing: 2px; border-bottom: 1px solid #222; padding-bottom: 20px; }
        .brand span { color: var(--green); }
        .menu-item { padding: 12px 15px; color: var(--sidebar-text); cursor: pointer; border-radius: 8px; margin-bottom: 8px; display: flex; align-items: center; gap: 15px; font-weight: 600; font-size: 0.95rem; }
        .menu-item:hover, .menu-item.active { background: var(--green); color: #000; padding-right: 20px; }
        .main-content { flex: 1; overflow-y: auto; padding: 30px; position: relative; }
        .top-bar { display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; border-bottom: 1px solid var(--border); padding-bottom: 20px; }
        .page-title { font-size: 1.6rem; font-weight: bold; color: var(--green); font-family: 'Cairo'; }

        /* === Components === */
        .grid-stats { display: grid; grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .stat-card { background: var(--panel); border: 1px solid var(--border); padding: 20px; border-radius: 12px; display: flex; align-items: center; gap: 20px; box-shadow: 0 5px 15px rgba(0,0,0,0.2); cursor: pointer; }
        .stat-card:hover { border-color: var(--green); }
        .stat-icon { width: 60px; height: 60px; background: rgba(0,230,118,0.1); color: var(--green); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 1.5rem; }
        .stat-info h3 { margin: 0; color: #888; font-size: 0.9rem; }
        .stat-info h1 { margin: 5px 0 0; font-size: 1.8rem; font-family: 'Montserrat'; }

        .table-container { background: var(--panel); border: 1px solid var(--border); border-radius: 12px; padding: 20px; overflow-x: auto; }
        table { width: 100%; border-collapse: collapse; margin-top: 10px; font-size: 0.9rem; }
        th, td { padding: 15px; text-align: right; border-bottom: 1px solid var(--border); }
        th { color: var(--green); font-size: 0.85rem; background: rgba(255,255,255,0.02); }
        tr:hover { background: var(--hover); }
        .status-dot { width: 10px; height: 10px; border-radius: 50%; display: inline-block; margin-left: 5px; }
        .online { background: var(--green); box-shadow: 0 0 10px var(--green); }
        .offline { background: #555; }

        .modal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.9); z-index: 10000; align-items: center; justify-content: center; backdrop-filter: blur(5px); }
        .modal-content { background: var(--panel); padding: 30px; border-radius: 15px; width: 600px; max-width: 95%; border: 1px solid var(--green); position: relative; max-height: 90vh; overflow-y: auto; }
        .close-modal { position: absolute; top: 15px; left: 15px; cursor: pointer; color: var(--error); font-size: 1.5rem; }
        .page-section { display: none; animation: fadeIn 0.4s; } .page-section.active { display: block; }
        .form-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        .status-select { background: #000; color: #fff; border: 1px solid #333; padding: 5px; border-radius: 5px; cursor: pointer; }
        label { display: block; margin-bottom: 8px; color: #aaa; font-size: 0.85rem; font-weight: bold; }
        
        .check-group { display: flex; gap: 10px; flex-wrap: wrap; margin-bottom: 10px; }
        .check-group label { background: #222; padding: 5px 10px; border: 1px solid #444; border-radius: 5px; cursor: pointer; color: #fff; font-weight: normal; font-size: 0.8rem; }
        .check-group input:checked + label { background: var(--green); color: #000; border-color: var(--green); }
        .check-group input { display: none; }

        /* === PRINT STYLES (Invoice) === */
        #invoiceTemplate { display: none; }
        @media print {
            body * { visibility: hidden; }
            #invoiceTemplate, #invoiceTemplate * { visibility: visible; }
            #invoiceTemplate { position: absolute; left: 0; top: 0; width: 100%; height: 100%; background: #fff; color: #000; padding: 20px; display: block; z-index: 99999; }
            .invoice-header { text-align: center; border-bottom: 2px solid #000; padding-bottom: 10px; margin-bottom: 20px; }
            .invoice-header h1 { margin: 0; font-family: 'Montserrat'; font-size: 2.5rem; }
            .inv-details { display: flex; justify-content: space-between; margin-bottom: 20px; border-bottom: 1px dashed #ccc; padding-bottom: 10px; }
            .inv-table { width: 100%; border-collapse: collapse; margin-top: 10px; }
            .inv-table th, .inv-table td { border: 1px solid #000; padding: 10px; text-align: center; }
            .inv-total { text-align: right; font-size: 1.5rem; font-weight: bold; margin-top: 20px; }
        }

        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body>

    <div id="invoiceTemplate">
        <div class="invoice-header">
            <h1>TRINEX STORE</h1>
            <p>Streetwear & Fashion</p>
        </div>
        <div class="inv-details">
            <div style="text-align:right;">
                <h3>Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø¹Ù…ÙŠÙ„</h3>
                <p>Ø§Ù„Ø§Ø³Ù…: <span id="pr_name"></span></p>
                <p>Ø§Ù„Ù‡Ø§ØªÙ: <span id="pr_phone"></span></p>
                <p>Ø§Ù„Ø¹Ù†ÙˆØ§Ù†: <span id="pr_address"></span></p>
            </div>
            <div style="text-align:left;">
                <h3>ØªÙØ§ØµÙŠÙ„ Ø§Ù„ÙØ§ØªÙˆØ±Ø©</h3>
                <p>Ø§Ù„ØªØ§Ø±ÙŠØ®: <span id="pr_date"></span></p>
                <p>Ø±Ù‚Ù… Ø§Ù„Ø·Ù„Ø¨: <span id="pr_id"></span></p>
            </div>
        </div>
        <table class="inv-table">
            <thead><tr><th>Ø§Ù„Ù…Ù†ØªØ¬</th><th>Ø§Ù„ØªÙØ§ØµÙŠÙ„</th><th>Ø§Ù„Ø³Ø¹Ø±</th></tr></thead>
            <tbody id="pr_items"></tbody>
        </table>
        <div class="inv-total">Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ: <span id="pr_total"></span></div>
        <p style="text-align:center; margin-top:50px;">Ø´ÙƒØ±Ø§Ù‹ Ù„Ø«Ù‚ØªÙƒÙ… ÙÙŠ TRINEX!</p>
    </div>

    <div id="loginScreen"><div class="overlay"></div><div class="login-box"><h1 style="color:#fff; font-family:'Montserrat'; letter-spacing:3px;">TRINEX <span style="color:var(--green)">HUB</span></h1><p style="color:#ccc; margin-bottom:20px;">SECURITY CLEARANCE REQUIRED</p><input type="email" id="adminEmail" class="inp-field" placeholder="Admin Email" style="direction:ltr;"><input type="password" id="adminPass" class="inp-field" placeholder="Password" style="direction:ltr;"><button class="main-btn" id="loginBtn" onclick="secureLogin()">LOGIN SYSTEM ğŸ”</button><p id="loginMsg" style="color:var(--error); display:none; margin-top:10px;">Access Denied.</p></div></div>
    
    <div id="appContainer" style="display:none; width:100%; height:100%;">
        <div class="sidebar">
            <div class="brand">TRINEX <span>ERP</span></div>
            <div class="menu-item active" onclick="nav('dashboard')"><i class="fas fa-chart-pie"></i> Ù†Ø¸Ø±Ø© Ø¹Ø§Ù…Ø©</div>
            <div class="menu-item" onclick="nav('products')"><i class="fas fa-tshirt"></i> Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª</div>
            <div class="menu-item" onclick="nav('customers')"><i class="fas fa-users"></i> Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡</div>
            <div class="menu-item" onclick="nav('orders')"><i class="fas fa-box"></i> Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø·Ù„Ø¨Ø§Øª</div>
            <div class="menu-item" onclick="nav('coupons')"><i class="fas fa-tags"></i> Ø§Ù„ÙƒÙˆØ¨ÙˆÙ†Ø§Øª</div>
            <div class="menu-item" onclick="nav('settings')"><i class="fas fa-sliders-h"></i> Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª</div>
            <div class="menu-item" onclick="logout()" style="margin-top:auto; color:var(--error);"><i class="fas fa-power-off"></i> ØªØ³Ø¬ÙŠÙ„ Ø®Ø±ÙˆØ¬</div>
        </div>
        <div class="main-content">
            <div class="top-bar"><div class="page-title" id="pageTitle">Ù„ÙˆØ­Ø© Ø§Ù„Ù‚ÙŠØ§Ø¯Ø©</div><div style="font-family:'Montserrat'; font-size:0.9rem; color:#666;" id="adminEmailDisplay"></div></div>
            
            <div id="dashboard" class="page-section active">
                <div class="grid-stats">
                    <div class="stat-card" onclick="openModal('visitsHistoryModal')"><div class="stat-icon"><i class="fas fa-eye"></i></div><div class="stat-info"><h3>Ø²ÙŠØ§Ø±Ø§Øª Ø§Ù„ÙŠÙˆÙ…</h3><h1 id="todayVisits">0</h1></div></div>
                    <div class="stat-card" onclick="nav('customers')"><div class="stat-icon" style="color:#29b6f6; background:rgba(41,182,246,0.1);"><i class="fas fa-wifi"></i></div><div class="stat-info"><h3>Ø£ÙˆÙ†Ù„Ø§ÙŠÙ† Ø§Ù„Ø¢Ù†</h3><h1 id="onlineUsers">0</h1></div></div>
                    <div class="stat-card" onclick="nav('orders')"><div class="stat-icon" style="color:#ffcc00; background:rgba(255,204,0,0.1);"><i class="fas fa-shopping-bag"></i></div><div class="stat-info"><h3>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø·Ù„Ø¨Ø§Øª</h3><h1 id="totalOrders">0</h1></div></div>
                </div>
            </div>

            <div id="products" class="page-section">
                <button class="main-btn" onclick="openProductModal()" style="width:auto; margin-bottom:20px;"><i class="fas fa-plus"></i> Ø¥Ø¶Ø§ÙØ© Ù…Ù†ØªØ¬ Ø¬Ø¯ÙŠØ¯</button>
                <div class="table-container"><table id="productsTable"><thead><tr><th>ØµÙˆØ±Ø©</th><th>Ø§Ù„Ø§Ø³Ù…</th><th>Ø§Ù„Ø³Ø¹Ø±</th><th>Ø§Ù„Ù‚Ø³Ù…</th><th>Ø§Ù„Ù…Ø®Ø²ÙˆÙ†</th><th>ØªØ­ÙƒÙ…</th></tr></thead><tbody></tbody></table></div>
            </div>

            <div id="customers" class="page-section">
                <div class="table-container"><table id="customersTable"><thead><tr><th>Ø§Ù„Ø¹Ù…ÙŠÙ„</th><th>Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ</th><th>Ø§Ù„Ø¹Ù†ÙˆØ§Ù†</th><th>Ø§Ù„Ø¨Ø§Ø³ÙˆØ±Ø¯</th><th>Ø§Ù„Ø·Ù„Ø¨Ø§Øª</th><th>ØªÙØ§ØµÙŠÙ„</th></tr></thead><tbody></tbody></table></div>
            </div>

            <div id="orders" class="page-section">
                <div class="table-container"><table id="ordersTable"><thead><tr><th>Ø±Ù‚Ù… Ø§Ù„Ø·Ù„Ø¨</th><th>Ø§Ù„Ø¹Ù…ÙŠÙ„</th><th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th><th>Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ</th><th>Ø­Ø§Ù„Ø© Ø§Ù„Ø·Ù„Ø¨</th><th>Ø·Ø¨Ø§Ø¹Ø©</th><th>ØªÙØ§ØµÙŠÙ„</th></tr></thead><tbody></tbody></table></div>
            </div>

            <div id="coupons" class="page-section">
                <div class="form-grid">
                    <div class="table-container" style="height:fit-content;">
                        <h3 style="color:var(--green); margin-top:0;">Ø¥Ø¶Ø§ÙØ© ÙƒÙˆØ¨ÙˆÙ† Ø¬Ø¯ÙŠØ¯</h3>
                        <input type="text" id="cpCode" class="inp-field" placeholder="Ø§Ù„ÙƒÙˆØ¯ (Ù…Ø«Ù„Ø§Ù‹: SAVE20)" style="text-transform:uppercase;">
                        <input type="number" id="cpVal" class="inp-field" placeholder="Ù†Ø³Ø¨Ø© Ø§Ù„Ø®ØµÙ… %">
                        <button class="main-btn" onclick="addCoupon()">Ø¥Ø¶Ø§ÙØ© Ø§Ù„ÙƒÙˆØ¨ÙˆÙ†</button>
                    </div>
                    <div class="table-container">
                        <h3 style="color:#fff; margin-top:0;">Ø§Ù„ÙƒÙˆØ¨ÙˆÙ†Ø§Øª Ø§Ù„ÙØ¹Ø§Ù„Ø©</h3>
                        <table id="couponsTable"><thead><tr><th>Ø§Ù„ÙƒÙˆØ¯</th><th>Ø§Ù„Ø®ØµÙ…</th><th>Ø­Ø°Ù</th></tr></thead><tbody></tbody></table>
                    </div>
                </div>
            </div>

            <div id="settings" class="page-section">
                <div class="table-container" style="max-width:600px;"><h3 style="color:var(--green);">âš™ï¸ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</h3><label>1. Ø´Ø±ÙŠØ· Ø§Ù„Ø¥Ø¹Ù„Ø§Ù†Ø§Øª Ø§Ù„Ø¹Ù„ÙˆÙŠ</label><input type="text" id="annBarText" class="inp-field"><label style="margin-top:15px;">2. ØµÙˆØ±Ø© Ø§Ù„Ø®Ù„ÙÙŠØ© (Hero Image)</label><input type="text" id="heroImgName" class="inp-field" placeholder="hode1.jpg" style="direction:ltr;"><button class="main-btn" onclick="saveSettings()" style="margin-top:20px;">Ø­ÙØ¸ ÙˆÙ†Ø´Ø± Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª ğŸš€</button></div>
            </div>
        </div>
    </div>

    <div id="productModal" class="modal"><div class="modal-content"><span class="close-modal" onclick="closeModal('productModal')">&times;</span><h2 id="modalTitle" style="color:var(--green); text-align:center; margin-top:0;">Ù…Ù†ØªØ¬ Ø¬Ø¯ÙŠØ¯</h2><input type="hidden" id="editProdId"><div class="form-grid"><div><label>Ø§Ø³Ù… Ø§Ù„Ù…Ù†ØªØ¬</label><input type="text" id="pName" class="inp-field"></div><div><label>Ø§Ù„Ø³Ø¹Ø± (EGP)</label><input type="number" id="pPrice" class="inp-field"></div></div><div class="form-grid"><div><label>Ø§Ù„Ù‚Ø³Ù…</label><select id="pCategory" class="inp-field" style="text-align:right;"><option value="winter">Ø´ØªÙˆÙŠ</option><option value="summer">ØµÙŠÙÙŠ</option><option value="pants">Ø¨Ù†Ø§Ø·ÙŠÙ„</option></select></div><div><label>Ø§Ù„ÙƒÙ…ÙŠØ©</label><input type="number" id="pStock" class="inp-field" value="10"></div></div>
    <label>Ø§Ù„Ù…Ù‚Ø§Ø³Ø§Øª Ø§Ù„Ù…ØªØ§Ø­Ø©:</label><div class="check-group"><input type="checkbox" id="sz_s" value="S"><label for="sz_s">S</label><input type="checkbox" id="sz_m" value="M"><label for="sz_m">M</label><input type="checkbox" id="sz_l" value="L"><label for="sz_l">L</label><input type="checkbox" id="sz_xl" value="XL"><label for="sz_xl">XL</label><input type="checkbox" id="sz_xxl" value="XXL"><label for="sz_xxl">XXL</label></div>
    <label>Ø§Ù„Ø£Ù„ÙˆØ§Ù† Ø§Ù„Ù…ØªØ§Ø­Ø©:</label><div class="check-group"><input type="checkbox" id="cl_black" value="Black"><label for="cl_black">Ø£Ø³ÙˆØ¯</label><input type="checkbox" id="cl_white" value="White"><label for="cl_white">Ø£Ø¨ÙŠØ¶</label><input type="checkbox" id="cl_grey" value="Grey"><label for="cl_grey">Ø±ØµØ§ØµÙŠ</label><input type="checkbox" id="cl_beige" value="Beige"><label for="cl_beige">Ø¨ÙŠØ¬</label></div>
    <label>Ø§Ø³Ù… Ø§Ù„ØµÙˆØ±Ø©</label><input type="text" id="pImg" class="inp-field" style="direction:ltr;"><button class="main-btn" onclick="saveProductData()">Ø­ÙØ¸ ÙˆÙ†Ø´Ø± âœ…</button></div></div>
    
    <div id="custModal" class="modal"><div class="modal-content" style="text-align:right;"><span class="close-modal" onclick="closeModal('custModal')">&times;</span><h2 style="color:var(--green);">Ù…Ù„Ù Ø§Ù„Ø¹Ù…ÙŠÙ„ ğŸ‘¤</h2><div id="custDetailsBody" style="line-height:1.8; color:#ccc;"></div><h3 style="margin-top:20px; color:#fff;">ğŸ“¦ Ø§Ù„Ù…ÙØ¶Ù„Ø© (Wishlist)</h3><ul id="custWishlist" style="color:var(--green);"></ul><h3 style="margin-top:20px; color:#fff;">ğŸ›’ Ø³Ø¬Ù„ Ø§Ù„Ø·Ù„Ø¨Ø§Øª</h3><div id="custOrdersHistory" style="max-height:200px; overflow-y:auto;"></div></div></div>
    <div id="visitsHistoryModal" class="modal"><div class="modal-content"><span class="close-modal" onclick="closeModal('visitsHistoryModal')">&times;</span><h2 style="color:var(--green);">Ø³Ø¬Ù„ Ø§Ù„Ø²ÙŠØ§Ø±Ø§Øª ğŸ“Š</h2><div id="visitsHistoryList" style="line-height:1.8; color:#ccc;">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</div></div></div>
    <div id="orderDetailsModal" class="modal"><div class="modal-content"><span class="close-modal" onclick="closeModal('orderDetailsModal')">&times;</span><h2 style="color:var(--green);">ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø·Ù„Ø¨ ğŸ§¾</h2><div id="fullOrderDetails" style="color:#ccc; line-height:1.6;"></div></div></div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
        import { getFirestore, collection, addDoc, getDocs, updateDoc, deleteDoc, doc, setDoc, query, orderBy, limit, onSnapshot, where } 
        from "https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js";
        import { getAuth, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-auth.js";
        const firebaseConfig = { apiKey: "AIzaSyDpC3kyBhy-mWsYjVAHxUuy2pqg_Sh0Z8U", authDomain: "trinex-store.firebaseapp.com", projectId: "trinex-store", storageBucket: "trinex-store.firebasestorage.app", messagingSenderId: "265387866506", appId: "1:265387866506:web:1fb7786e186cf0abf43073" };
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);

        window.secureLogin = async function() {
            let email = document.getElementById('adminEmail').value; let pass = document.getElementById('adminPass').value;
            try { await signInWithEmailAndPassword(auth, email, pass); } catch(e) { document.getElementById('loginMsg').style.display='block'; }
        }
        window.logout = () => signOut(auth).then(() => location.reload());
        onAuthStateChanged(auth, (user) => {
            if(user) { document.getElementById('loginScreen').style.display='none'; document.getElementById('appContainer').style.display='flex'; document.getElementById('adminEmailDisplay').innerText = user.email; initDashboard(); }
            else { document.getElementById('loginScreen').style.display='flex'; document.getElementById('appContainer').style.display='none'; }
        });

        function initDashboard() { loadProducts(); loadCustomers(); loadStats(); loadSettings(); loadOrders(); loadCoupons(); }
        
        function loadProducts() {
            onSnapshot(query(collection(db, "products"), orderBy("createdAt", "desc")), (snap) => {
                let html = ""; snap.forEach(doc => { let p=doc.data(); let safe=JSON.stringify(p).replace(/"/g,'&quot;'); html+=`<tr><td><img src="${p.img}" width="40"></td><td>${p.name}</td><td style="color:var(--green)">${p.price}</td><td>${p.category}</td><td>${p.stock}</td><td><button onclick="openProductModal('${doc.id}', ${safe})"><i class="fas fa-edit"></i></button><button onclick="deleteProd('${doc.id}')" style="color:var(--error)"><i class="fas fa-trash"></i></button></td></tr>`; });
                document.querySelector('#productsTable tbody').innerHTML = html;
            });
        }
        window.openProductModal = (id=null, data=null) => {
            const m = document.getElementById('productModal');
            document.querySelectorAll('.check-group input').forEach(c => c.checked = false);
            if(id && data) { 
                document.getElementById('modalTitle').innerText="ØªØ¹Ø¯ÙŠÙ„"; document.getElementById('editProdId').value=id; document.getElementById('pName').value=data.name; document.getElementById('pPrice').value=data.price; document.getElementById('pCategory').value=data.category; document.getElementById('pStock').value=data.stock; document.getElementById('pImg').value=data.img; 
                if(data.sizes) data.sizes.forEach(s => { try{document.querySelector(`input[value="${s}"]`).checked=true}catch(e){} });
                if(data.colors) data.colors.forEach(c => { try{document.querySelector(`input[value="${c}"]`).checked=true}catch(e){} });
            }
            else { document.getElementById('modalTitle').innerText="Ø¬Ø¯ÙŠØ¯"; document.getElementById('editProdId').value=""; document.querySelectorAll('#productModal .inp-field').forEach(i=>i.value=""); }
            m.style.display='flex';
        }
        window.saveProductData = async () => {
            let id = document.getElementById('editProdId').value;
            let sizes = Array.from(document.querySelectorAll('#productModal input[type="checkbox"]:checked')).filter(c=>['S','M','L','XL','XXL'].includes(c.value)).map(c=>c.value);
            let colors = Array.from(document.querySelectorAll('#productModal input[type="checkbox"]:checked')).filter(c=>!['S','M','L','XL','XXL'].includes(c.value)).map(c=>c.value);
            let d = { 
                name: document.getElementById('pName').value, price: Number(document.getElementById('pPrice').value), 
                category: document.getElementById('pCategory').value, stock: Number(document.getElementById('pStock').value), 
                img: document.getElementById('pImg').value,
                sizes: sizes.length ? sizes : ['M', 'L'], colors: colors.length ? colors : ['Black']
            };
            if(id) { await updateDoc(doc(db,"products",id), d); } else { d.createdAt=new Date(); d.savedCount=0; await addDoc(collection(db,"products"), d); }
            closeModal('productModal');
        }
        window.deleteProd = async (id) => { if(confirm("Ø­Ø°ÙØŸ")) await deleteDoc(doc(db,"products",id)); }

        function loadCustomers() {
            onSnapshot(query(collection(db, "users"), orderBy("lastSeen", "desc")), (snap) => {
                let html=""; let online=0; let now=new Date();
                snap.forEach(doc => {
                    let u=doc.data(); let ls=u.lastSeen?u.lastSeen.toDate():new Date(0);
                    if((now-ls)<5*60*1000) online++;
                    let safe=JSON.stringify({...u, uid: doc.id}).replace(/"/g,'&quot;');
                    html+=`<tr><td><span class="status-dot ${((now-ls)<300000)?'online':'offline'}"></span> ${u.name}</td><td>${u.phone}</td><td>${u.address||'-'}</td><td style="font-family:monospace; color:#888;">${u.password||'***'}</td><td>${u.ordersCount||0}</td><td><button onclick="showCustomer(${safe})"><i class="fas fa-eye"></i></button></td></tr>`;
                });
                document.querySelector('#customersTable tbody').innerHTML=html; document.getElementById('onlineUsers').innerText=online;
            });
        }
        window.showCustomer = async (u) => {
            document.getElementById('custDetailsBody').innerHTML = `<p><b>Ø§Ù„Ø§Ø³Ù…:</b> ${u.name}</p><p><b>Ù…ÙˆØ¨Ø§ÙŠÙ„:</b> ${u.phone}</p><p><b>Ø¹Ù†ÙˆØ§Ù†:</b> ${u.address}</p><p><b>Ø§Ù†Ø¶Ù…:</b> ${u.joinedAt?new Date(u.joinedAt.seconds*1000).toLocaleDateString():'-'}</p>`;
            document.getElementById('custWishlist').innerHTML = u.wishlistItems ? u.wishlistItems.map(i => `<li>${i.name}</li>`).join('') : "<li>Ù„Ø§ ÙŠÙˆØ¬Ø¯</li>";
            const qOrders = query(collection(db, "orders"), where("userId", "==", u.uid));
            const snap = await getDocs(qOrders);
            let ordersHTML = "";
            snap.forEach(d => { let o = d.data(); ordersHTML += `<div style="border:1px solid #333; padding:5px; margin-bottom:5px; font-size:0.85rem;"><span>${o.date}</span> - <span style="color:var(--green)">${o.total}</span> - ${o.status||'New'}</div>`; });
            document.getElementById('custOrdersHistory').innerHTML = ordersHTML || "Ù„Ø§ ØªÙˆØ¬Ø¯ Ø·Ù„Ø¨Ø§Øª";
            document.getElementById('custModal').style.display='flex';
        }

        // --- Orders (With Print) ---
        function loadOrders() {
            onSnapshot(query(collection(db, "orders"), orderBy("date", "desc")), (snap) => {
                let html=""; 
                snap.forEach(doc => {
                    let o = doc.data(); let safe=JSON.stringify({...o, id:doc.id}).replace(/"/g,'&quot;');
                    let st = o.status || 'New';
                    let statusColor = st === 'New' ? '#fff' : (st === 'Shipped' ? 'orange' : 'var(--green)');
                    html += `<tr>
                        <td>${doc.id.substr(0,5)}..</td><td>${o.customerName}<br><span style="font-size:0.8rem;color:#666">${o.phone}</span></td><td>${o.date}</td><td style="color:var(--green)">${o.total}</td>
                        <td><select class="status-select" onchange="updateStatus('${doc.id}', this.value)" style="color:${statusColor}; border-color:${statusColor}"><option value="New" ${st==='New'?'selected':''}>Ø¬Ø¯ÙŠØ¯</option><option value="Shipped" ${st==='Shipped'?'selected':''}>Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø´Ø­Ù†</option><option value="Delivered" ${st==='Delivered'?'selected':''}>ØªÙ… Ø§Ù„ØªÙˆØµÙŠÙ„</option></select></td>
                        <td><button onclick="printInvoice(${safe})" style="color:var(--info); border:1px solid var(--info); background:none; padding:5px; border-radius:5px; cursor:pointer;"><i class="fas fa-print"></i></button></td>
                        <td><button onclick="showOrder(${safe})"><i class="fas fa-list"></i></button></td>
                    </tr>`;
                });
                document.querySelector('#ordersTable tbody').innerHTML = html;
            });
        }
        window.updateStatus = async (id, val) => { await updateDoc(doc(db, "orders", id), { status: val }); }
        window.showOrder = (o) => {
            let itemsHtml = o.items.map(i => `<li>${i.name} (${i.price} EGP) [${i.size}/${i.color}]</li>`).join('');
            document.getElementById('fullOrderDetails').innerHTML = `<p><b>Ø§Ù„Ø¹Ù…ÙŠÙ„:</b> ${o.customerName}</p><p><b>Ø§Ù„Ù‡Ø§ØªÙ:</b> ${o.phone}</p><p><b>Ø§Ù„Ø¹Ù†ÙˆØ§Ù†:</b> ${o.address}</p><hr><ul>${itemsHtml}</ul><h3>Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ: ${o.total}</h3>`;
            document.getElementById('orderDetailsModal').style.display='flex';
        }
        window.printInvoice = (o) => {
            document.getElementById('pr_name').innerText = o.customerName;
            document.getElementById('pr_phone').innerText = o.phone;
            document.getElementById('pr_address').innerText = o.address;
            document.getElementById('pr_date').innerText = o.date;
            document.getElementById('pr_id').innerText = o.id.substr(0,8);
            document.getElementById('pr_total').innerText = o.total;
            let items = "";
            o.items.forEach(i => items += `<tr><td>${i.name}</td><td>${i.size || '-'} / ${i.color || '-'}</td><td>${i.price}</td></tr>`);
            document.getElementById('pr_items').innerHTML = items;
            window.print();
        }

        function loadCoupons() { onSnapshot(collection(db, "coupons"), (snap) => { let html = ""; snap.forEach(doc => { let c = doc.data(); html += `<tr><td>${c.code}</td><td>${c.discount}%</td><td><button onclick="deleteDoc(doc(db,'coupons','${doc.id}'))" style="color:red"><i class="fas fa-trash"></i></button></td></tr>`; }); document.querySelector('#couponsTable tbody').innerHTML = html; }); }
        window.addCoupon = async () => { let code = document.getElementById('cpCode').value.toUpperCase(); let val = document.getElementById('cpVal').value; if(!code || !val) return alert("Ø§ÙƒØªØ¨ Ø§Ù„ÙƒÙˆØ¯ ÙˆØ§Ù„Ù†Ø³Ø¨Ø©"); await addDoc(collection(db, "coupons"), { code: code, discount: Number(val) }); alert("ØªÙ… âœ…"); document.getElementById('cpCode').value = ""; document.getElementById('cpVal').value = ""; }

        function loadStats() {
            const today = new Date().toISOString().split('T')[0];
            onSnapshot(collection(db, "stats"), (snap) => {
                let todayData = snap.docs.find(d => d.id === today);
                document.getElementById('todayVisits').innerText = todayData ? (todayData.data().visits || 0) : 0;
                let historyHTML = ""; snap.docs.forEach(d => { historyHTML += `<div style="border-bottom:1px solid #333; padding:5px; display:flex; justify-content:space-between;"><span>${d.id}</span><span style="color:var(--green)">${d.data().visits} Ø²ÙŠØ§Ø±Ø©</span></div>`; });
                document.getElementById('visitsHistoryList').innerHTML = historyHTML;
            });
            onSnapshot(collection(db, "orders"), (snap) => document.getElementById('totalOrders').innerText = snap.size);
        }
        async function loadSettings() { try { const s = await getDocs(collection(db, "settings")); if(!s.empty) { let d = s.docs[0].data(); document.getElementById('annBarText').value = d.announcement||""; document.getElementById('heroImgName').value = d.heroImg||""; } } catch(e){} }
        window.saveSettings = async function() { try { await setDoc(doc(db, "settings", "general"), { announcement: document.getElementById('annBarText').value, heroImg: document.getElementById('heroImgName').value }, { merge: true }); alert("âœ… ØªÙ… Ø§Ù„ØªØ­Ø¯ÙŠØ«"); } catch(e){ alert("Error"); } }

        window.nav = (id) => { document.querySelectorAll('.page-section').forEach(p=>p.classList.remove('active')); document.getElementById(id).classList.add('active'); document.querySelectorAll('.menu-item').forEach(m=>m.classList.remove('active')); event.currentTarget.classList.add('active'); document.getElementById('pageTitle').innerText=event.currentTarget.innerText; }
        window.closeModal = (id) => document.getElementById(id).style.display='none';
        window.openModal = (id) => document.getElementById(id).style.display='flex';
    </script>
</body>
</html>